services:
  backend:
    build:
      context: ./backend
      target: dev
    profiles:
      - dev
    env_file:
      - ./backend/.env
    environment:
      DEBUG: "True"
      ALLOWED_HOSTS: "localhost,127.0.0.1,0.0.0.0"
      CORS_ALLOWED_ORIGINS: "http://localhost:5173,http://127.0.0.1:5173"
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - backend_media:/app/media
    healthcheck:
      test: ["CMD-SHELL","python -c 'import socket; socket.create_connection((\"localhost\", 8000), 2)'"]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      target: dev
    profiles:
      - dev
    env_file:
      - ./frontend/.env
    command: ["sh","-c","test -f .env && grep -Eq '^VITE_API_BASE_URL=' .env || { echo 'VITE_API_BASE_URL missing in frontend/.env'; exit 1; }; npm run dev -- --host 0.0.0.0"]
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL","node -e 'require(\"http\").get(\"http://localhost:5173\",()=>process.exit(0)).on(\"error\",()=>process.exit(1))' "]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  backend-prod:
    build:
      context: ./backend
      target: prod
    profiles:
      - prod
    env_file:
      - ./backend/.env
    environment:
      DEBUG: "False"
      ALLOWED_HOSTS: "localhost,127.0.0.1"
      CORS_ALLOWED_ORIGINS: "http://localhost:8080,http://127.0.0.1:8080"
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD-SHELL","python -c 'import socket; socket.create_connection((\"localhost\", 8000), 2)'"]
      interval: 10s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  frontend-prod:
    build:
      context: ./frontend
      target: prod
    profiles:
      - prod
    ports:
      - "8080:8080"
    depends_on:
      backend-prod:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL","wget -q --spider http://localhost:8080 || exit 1"]
    restart: unless-stopped

volumes:
  backend_media:
  frontend_node_modules: